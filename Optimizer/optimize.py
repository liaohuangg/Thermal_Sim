#!/usr/bin/env python3
import subprocess
import os
import re
import random
import time
import shutil
import matplotlib.pyplot as plt
from datetime import datetime
import csv
import glob
from PIL import Image


class Block:
    def __init__(self, name, width, height, x, y):
        self.name = name
        self.width = float(width)
        self.height = float(height)
        self.x = float(x)
        self.y = float(y)
    
    def __str__(self):
        return f"{self.name}\t{self.width:.6f}\t{self.height:.6f}\t{self.x:.6f}\t{self.y:.6f}"
    
    def copy(self):
        return Block(self.name, self.width, self.height, self.x, self.y)

class LayoutOptimizer:
    def __init__(self, config, base_path="."):
        self.config = config
        self.results_dir = os.path.join(base_path, f"results_{datetime.now().strftime('%Y%m%d_%H%M%S')}")
        os.makedirs(self.results_dir, exist_ok=True)
        
        # åˆå§‹åŒ–å†å²è®°å½•
        self.history = {
            'iteration': [],
            'temperature': [],
            'layout_file': [],
            'thermal_image': [],
            'acceptance': [],
            'time': []
        }
        
        # åˆ›å»ºCSVæ–‡ä»¶
        with open(os.path.join(self.results_dir, "optimization_history.csv"), "w") as f:
            f.write("Iteration,Temperature,LayoutFile,ThermalImage,Acceptance,Time\n")
    
    def parse_flp(self, filename):
        """è§£æFLPå¸ƒå±€æ–‡ä»¶"""
        blocks = []
        with open(filename, 'r') as f:
            for line in f:
                if line.startswith('#') or not line.strip():
                    continue
                parts = line.split()
                if len(parts) == 5:
                    blocks.append(Block(parts[0], parts[1], parts[2], parts[3], parts[4]))
        return blocks
    
    def write_flp(self, filename, blocks):
        """å†™å…¥FLPå¸ƒå±€æ–‡ä»¶"""
        with open(filename, 'w') as f:
            f.write("# Floorplan generated by optimizer\n")
            f.write("# Format: <unit-name>\t<width>\t<height>\t<left-x>\t<bottom-y>\n\n")
            for block in blocks:
                f.write(f"{block}\n")
    
    def get_chip_bounds(self, blocks):
        """è·å–èŠ¯ç‰‡è¾¹ç•Œå°ºå¯¸"""
        width = max(block.x + block.width for block in blocks)
        height = max(block.y + block.height for block in blocks)
        return width, height
    
    def perturb_layout(self, blocks, chip_width, chip_height):
        """éšæœºæ‰°åŠ¨å¸ƒå±€"""
        new_blocks = [block.copy() for block in blocks]
        idx = random.randint(0, len(new_blocks) - 1)
        block = new_blocks[idx]
        
        # è®¡ç®—å®‰å…¨ç§»åŠ¨èŒƒå›´
        max_x = chip_width - block.width
        max_y = chip_height - block.height
        
        # ç”Ÿæˆæ–°ä½ç½®
        block.x = random.uniform(0, max_x)
        block.y = random.uniform(0, max_y)
        
        return new_blocks
    
    def run_hotspot_simulation(self, iteration, layout_file):
        """è¿è¡ŒHotSpotçƒ­ä»¿çœŸï¼ˆä½¿ç”¨åŸæœ‰çš„run.shï¼‰"""
        iter_dir = os.path.join(self.results_dir, f"iteration_{iteration:03d}")
        os.makedirs(iter_dir, exist_ok=True)
        
        # å‡†å¤‡æ–‡ä»¶
        shutil.copy(layout_file, os.path.join(iter_dir, "ev6.flp"))
        for file in ["run.sh", "example.config", "gcc.ptrace", "example.materials"]:
            if os.path.exists(file):
                shutil.copy(file, iter_dir)
        
        # è¿è¡ŒåŸæœ‰çš„run.shè„šæœ¬
        start_time = time.time()
        try:
            # è¿è¡Œè„šæœ¬
            subprocess.run(["./run.sh"], cwd=iter_dir, check=True)
            
            # åˆ›å»ºè¾“å‡ºç›®å½•
            out_dir = os.path.join(iter_dir, "outputs")
            os.makedirs(out_dir, exist_ok=True)
            
            # ç§»åŠ¨ç”Ÿæˆçš„è¾“å‡ºæ–‡ä»¶
            for file in glob.glob(os.path.join(iter_dir, "gcc.*")):
                if os.path.isfile(file):
                    os.rename(file, os.path.join(out_dir, os.path.basename(file)))
            
            # ç§»åŠ¨HotSpotç”Ÿæˆçš„è¾“å‡ºç›®å½•
            if os.path.exists(os.path.join(iter_dir, "outputs")):
                for file in os.listdir(os.path.join(iter_dir, "outputs")):
                    src = os.path.join(iter_dir, "outputs", file)
                    dst = os.path.join(out_dir, file)
                    if os.path.isfile(src):
                        shutil.move(src, dst)
            
            # è§£ææ¸©åº¦
            max_temp = 0.0
            steady_file = os.path.join(out_dir, "gcc.steady")
            if os.path.exists(steady_file):
                with open(steady_file, "r") as f:
                    for line in f:
                        if line.strip():
                            parts = line.split()
                            if len(parts) >= 2:
                                try:
                                    temp = float(parts[1])
                                    max_temp = max(max_temp, temp)
                                except ValueError:
                                    continue
            
            # è·å–çƒ­åŠ›å›¾
            thermal_image = ""
            png_files = glob.glob(os.path.join(out_dir, "*.png"))
            if png_files:
                thermal_image = png_files[0]
                
                # åˆ›å»ºç¼©ç•¥å›¾
                try:
                    img = Image.open(thermal_image)
                    img.thumbnail((300, 300))
                    thumbnail_path = os.path.join(out_dir, "thumbnail.png")
                    img.save(thumbnail_path)
                except Exception as e:
                    print(f"åˆ›å»ºç¼©ç•¥å›¾å¤±è´¥: {e}")
            
            elapsed_time = time.time() - start_time
            return max_temp, thermal_image, elapsed_time
        
        except Exception as e:
            print(f"ä»¿çœŸå¤±è´¥: {e}")
            elapsed_time = time.time() - start_time
            return float('inf'), "", elapsed_time
    
    def save_iteration_data(self, iteration, temperature, layout_file, thermal_image, acceptance, elapsed_time):
        """ä¿å­˜è¿­ä»£æ•°æ®"""
        self.history['iteration'].append(iteration)
        self.history['temperature'].append(temperature)
        self.history['layout_file'].append(layout_file)
        self.history['thermal_image'].append(thermal_image)
        self.history['acceptance'].append(acceptance)
        self.history['time'].append(elapsed_time)
        
        # ä¿å­˜åˆ°CSV
        with open(os.path.join(self.results_dir, "optimization_history.csv"), "a") as f:
            f.write(f"{iteration},{temperature},{layout_file},{thermal_image},{acceptance},{elapsed_time}\n")
        
        # ç»˜åˆ¶æ¸©åº¦å†å²å›¾
        plt.figure(figsize=(10, 6))
        plt.plot(self.history['iteration'], self.history['temperature'], 'bo-')
        plt.xlabel('Iteration')
        plt.ylabel('Max Temperature (K)')
        plt.title('Temperature Optimization Progress')
        plt.grid(True)
        plt.savefig(os.path.join(self.results_dir, "temperature_history.png"))
        plt.close()
    
    def generate_html_report(self):
        """ç”ŸæˆHTMLæŠ¥å‘Š"""
        if not self.history['temperature']:
            print("è­¦å‘Š: æ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®ç”ŸæˆæŠ¥å‘Š")
            return
            
        best_temp = min(self.history['temperature'])
        best_idx = self.history['temperature'].index(best_temp)
        best_iter = self.history['iteration'][best_idx]
        
        # ç”ŸæˆHTMLå†…å®¹
        html = f"""
        <!DOCTYPE html>
        <html>
        <head>
            <title>Chip Thermal Optimization Report</title>
            <meta charset="UTF-8">
            <style>
                body {{ font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }}
                .container {{ max-width: 1200px; margin: 0 auto; }}
                .header {{ background-color: #2c3e50; color: white; padding: 20px; border-radius: 5px; margin-bottom: 20px; }}
                .stats {{ background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }}
                .grid-container {{ display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }}
                .card {{ background-color: white; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 15px; }}
                .card h3 {{ margin-top: 0; color: #2c3e50; }}
                .iteration-grid {{ display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }}
                .iteration-card {{ background-color: white; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 15px; }}
                .iteration-card h4 {{ margin-top: 0; }}
                .iteration-card img {{ max-width: 100%; border: 1px solid #ddd; border-radius: 3px; }}
                .best {{ border: 2px solid #27ae60; }}
                .temperature-history {{ width: 100%; }}
                .summary-table {{ width: 100%; border-collapse: collapse; }}
                .summary-table th, .summary-table td {{ border: 1px solid #ddd; padding: 8px; text-align: left; }}
                .summary-table th {{ background-color: #f2f2f2; }}
                .acceptance {{ font-weight: bold; }}
                .accepted {{ color: #27ae60; }}
                .rejected {{ color: #e74c3c; }}
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>Chip Thermal Optimization Report</h1>
                    <p>Generated on {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
                </div>
                
                <div class="stats">
                    <h2>Optimization Summary</h2>
                    <table class="summary-table">
                        <tr>
                            <th>Metric</th>
                            <th>Value</th>
                        </tr>
                        <tr>
                            <td>Total Iterations</td>
                            <td>{len(self.history['iteration'])}</td>
                        </tr>
                        <tr>
                            <td>Initial Temperature</td>
                            <td>{self.history['temperature'][0]:.2f} K</td>
                        </tr>
                        <tr>
                            <td>Best Temperature</td>
                            <td>{best_temp:.2f} K (Iteration {best_iter})</td>
                        </tr>
                        <tr>
                            <td>Temperature Reduction</td>
                            <td>{self.history['temperature'][0] - best_temp:.2f} K</td>
                        </tr>
                        <tr>
                            <td>Total Optimization Time</td>
                            <td>{sum(self.history['time']):.1f} seconds</td>
                        </tr>
                        <tr>
                            <td>Acceptance Rate</td>
                            <td>{sum(self.history['acceptance']) / len(self.history['acceptance']) * 100:.1f}%</td>
                        </tr>
                    </table>
                    
                    <h2>Temperature History</h2>
                    <img class="temperature-history" src="temperature_history.png" alt="Temperature History">
                </div>
                
                <div class="grid-container">
                    <div class="card">
                        <h3>Best Thermal Result</h3>
                        <img src="{self.history['thermal_image'][best_idx]}" alt="Best Thermal Map">
                        <p>Iteration: {best_iter}, Temperature: {best_temp:.2f} K</p>
                    </div>
                    
                    <div class="card">
                        <h3>Initial Thermal Result</h3>
                        <img src="{self.history['thermal_image'][0]}" alt="Initial Thermal Map">
                        <p>Iteration: 0, Temperature: {self.history['temperature'][0]:.2f} K</p>
                    </div>
                </div>
                
                <h2>Iteration History</h2>
                <div class="iteration-grid">
        """
        
        # æ·»åŠ è¿­ä»£å¡ç‰‡
        for i in range(len(self.history['iteration'])):
            iteration = self.history['iteration'][i]
            temp = self.history['temperature'][i]
            layout_file = self.history['layout_file'][i]
            thermal_image = self.history['thermal_image'][i]
            accepted = "Accepted" if self.history['acceptance'][i] else "Rejected"
            
            # ä½¿ç”¨ç¼©ç•¥å›¾
            thumbnail = thermal_image
            if thermal_image:
                thumbnail_dir = os.path.dirname(thermal_image)
                thumbnail_path = os.path.join(thumbnail_dir, "thumbnail.png")
                if os.path.exists(thumbnail_path):
                    thumbnail = thumbnail_path
            
            html += f"""
                    <div class="iteration-card {'best' if i == best_idx else ''}">
                        <h4>Iteration {iteration}</h4>
                        <p>Temperature: {temp:.2f} K</p>
                        <p>Status: <span class="acceptance {'accepted' if self.history['acceptance'][i] else 'rejected'}">{accepted}</span></p>
                        <img src="{thumbnail}" alt="Thermal Map Iteration {iteration}">
                        <p>Layout: {os.path.basename(layout_file)}</p>
                    </div>
            """
        
        html += """
                </div>
            </div>
        </body>
        </html>
        """
        
        # å†™å…¥æ–‡ä»¶
        with open(os.path.join(self.results_dir, "report.html"), "w") as f:
            f.write(html)
    
    def optimize(self):
        """æ‰§è¡Œä¼˜åŒ–è¿‡ç¨‹"""
        # è¯»å–é…ç½®
        print("===start optimize===")
        initial_temp = self.config.get("initial_temp", 100.0)
        cooling_rate = self.config.get("cooling_rate", 0.95)
        max_iterations = self.config.get("max_iterations", 50)
        layout_file = self.config.get("layout_file", "ev6.flp")
        
        # æ£€æŸ¥å¸ƒå±€æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if not os.path.exists(layout_file):
            print(f"é”™è¯¯: æ‰¾ä¸åˆ°å¸ƒå±€æ–‡ä»¶ {layout_file}")
            return
        
        # è§£æå¸ƒå±€æ–‡ä»¶
        blocks = self.parse_flp(layout_file)
        chip_width, chip_height = self.get_chip_bounds(blocks)
        
        # åˆå§‹ä»¿çœŸ
        print("è¿è¡Œåˆå§‹ä»¿çœŸ...")
        current_temp, thermal_img, elapsed_time = self.run_hotspot_simulation(0, layout_file)
        
        # ä¿å­˜åˆå§‹æ•°æ®
        self.save_iteration_data(0, current_temp, layout_file, thermal_img, True, elapsed_time)
        print(f"åˆå§‹æ¸©åº¦: {current_temp:.2f} K")
        
        best_temp = current_temp
        best_blocks = [b.copy() for b in blocks]
        current_blocks = [b.copy() for b in blocks]
        
        # ä¼˜åŒ–å¾ªç¯
        print(f"\nå¼€å§‹ä¼˜åŒ–ï¼Œå…± {max_iterations} æ¬¡è¿­ä»£...")
        for i in range(1, max_iterations + 1):
            print(f"\nè¿­ä»£ {i}/{max_iterations}:")
            
            # ç”Ÿæˆæ–°å¸ƒå±€
            new_blocks = self.perturb_layout(current_blocks, chip_width, chip_height)
            temp_file = f"temp_{i}.flp"
            self.write_flp(temp_file, new_blocks)
            
            # è¿è¡Œä»¿çœŸ
            print("è¿è¡Œçƒ­ä»¿çœŸ...")
            new_temp, thermal_img, elapsed_time = self.run_hotspot_simulation(i, temp_file)
            
            # æ¥å—æ¦‚ç‡è®¡ç®—
            delta_temp = new_temp - current_temp
            accept_prob = min(1.0, pow(2.718, -delta_temp / initial_temp))
            accepted = False
            
            # æ›´æ–°çŠ¶æ€
            if delta_temp < 0 or random.random() < accept_prob:
                accepted = True
                current_temp = new_temp
                current_blocks = new_blocks
                
                if new_temp < best_temp:
                    best_temp = new_temp
                    best_blocks = [b.copy() for b in current_blocks]
                    print(f"ğŸ”¥ æ–°æœ€ä½³æ¸©åº¦: {best_temp:.2f} K")
            
            # ä¿å­˜è¿­ä»£æ•°æ®
            self.save_iteration_data(i, new_temp, f"iteration_{i:03d}/ev6.flp", thermal_img, accepted, elapsed_time)
            print(f"æ¸©åº¦: {new_temp:.2f} K, è€—æ—¶: {elapsed_time:.1f}ç§’, çŠ¶æ€: {'æ¥å—' if accepted else 'æ‹’ç»'}")
            
            # é™æ¸©
            initial_temp *= cooling_rate
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            if os.path.exists(temp_file):
                os.remove(temp_file)
        
        # ä¿å­˜æœ€ä½³å¸ƒå±€
        best_layout_path = os.path.join(self.results_dir, "best_layout.flp")
        self.write_flp(best_layout_path, best_blocks)
        
        # ç”ŸæˆæŠ¥å‘Š
        print("\nç”Ÿæˆä¼˜åŒ–æŠ¥å‘Š...")
        self.generate_html_report()
        
        print("\n" + "="*50)
        print(f"ä¼˜åŒ–å®Œæˆ! æœ€ä½³æ¸©åº¦: {best_temp:.2f} K")
        print(f"æœ€ä½³å¸ƒå±€ä¿å­˜è‡³: {best_layout_path}")
        print(f"å®Œæ•´ç»“æœä¿å­˜è‡³: {self.results_dir}")
        print(f"HTMLæŠ¥å‘Š: {os.path.join(self.results_dir, 'report.html')}")
        print("="*50)

if __name__ == "__main__":
    # é…ç½®å‚æ•°
    config = {
        "layout_file": "ev6.flp",          # å¸ƒå±€æ–‡ä»¶
        "initial_temp": 100.0,             # åˆå§‹æ¸©åº¦ï¼ˆæ¨¡æ‹Ÿé€€ç«ï¼‰
        "cooling_rate": 0.95,               # é™æ¸©é€Ÿç‡
        "max_iterations": 1                # æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼ˆå»ºè®®20-50ï¼‰
    }
    
    # æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
    print("===start===")
    # print("="*50)
    # print("èŠ¯ç‰‡çƒ­ä¼˜åŒ–ç³»ç»Ÿ - è‡ªåŠ¨åŒ–å¸ƒå±€è®¾è®¡")
    # print("="*50)
    # print("æœ¬ç³»ç»Ÿå°†è‡ªåŠ¨è¿›è¡Œä»¥ä¸‹æ“ä½œ:")
    # print("1. è¯»å–åˆå§‹å¸ƒå±€æ–‡ä»¶ (ev6.flp)")
    # print("2. è¿è¡Œçƒ­ä»¿çœŸè·å–åˆå§‹æ¸©åº¦")
    # print("3. ä½¿ç”¨æ¨¡æ‹Ÿé€€ç«ç®—æ³•ä¼˜åŒ–å¸ƒå±€")
    # print("4. æ¯æ¬¡è¿­ä»£ç”Ÿæˆæ–°å¸ƒå±€å¹¶è¿è¡Œçƒ­ä»¿çœŸ")
    # print("5. è®°å½•æ‰€æœ‰è¿­ä»£ç»“æœå¹¶ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Š")
    # print("="*50)

    # å®šä¹‰éœ€è¦çš„æ–‡ä»¶ï¼Œä¼˜å…ˆä»ç¯å¢ƒå˜é‡å–è·¯å¾„ï¼Œå¦åˆ™ç”¨é»˜è®¤æ–‡ä»¶å
    FILE_CONFIG = {
        "run_sh": os.getenv("RUN_SH", "run.sh"),
        "example_config": os.getenv("EXAMPLE_CONFIG", "example.config"),
        "gcc_ptrace": os.getenv("GCC_PTRACE", "gcc.ptrace"),
        "example_materials": os.getenv("EXAMPLE_MATERIALS", "example.materials"),
        "ev6_flp": os.getenv("EV6_FLP", "ev6.flp")
    }

   # æå–æ‰€æœ‰æ–‡ä»¶è·¯å¾„
    required_files = list(FILE_CONFIG.values())

    # æ£€æŸ¥ç¼ºå¤±æ–‡ä»¶
    missing_files = [f for f in required_files if not os.path.exists(f)]

    if missing_files:
        print("é”™è¯¯ï¼šç¼ºå°‘å¿…è¦æ–‡ä»¶:")
        for f in missing_files:
            print(f" - {f}")
        print("æç¤ºï¼šå¯é€šè¿‡ç¯å¢ƒå˜é‡æŒ‡å®šè·¯å¾„ï¼Œä¾‹å¦‚ï¼š")
        print(" export RUN_SH=/path/to/run.sh")
        exit(1)
    
    # åˆ›å»ºä¼˜åŒ–å™¨å¹¶è¿è¡Œ
    optimizer = LayoutOptimizer(config, "/root/Experiment/Thermal_Sim/output/")
    optimizer.optimize()